{% extends 'aprender/index.html' %}
{% load static %}
{% block head %}
{% endblock head %}
{% block body %}
<section>
    <!-- //TODO fodler blabla finish when back end is ready -->

    <section>
        <h1 id="label">{{folder.label}}</h1>
        <input type="text" value="{{folder.label}}" class="hidden" id="labelInput">
    </section>
    {% if folder.description %}
    <section>
        <p id="description">{{folder.description}}</p>
        <input id="descriptionInput" type="text" value="{{folder.description}}" class="hidden">
    </section>
    {% endif %}
</section>
<section>
    {% if not folder.sets %}
    <p>It seems that any sets are in folder yet!</p>
    {% endif %}
    <script type="text/javascript" src="{% static 'js/jquery.js'%}"></script>
    <style>
        .included {
            background-color: green !important;
        }
    </style>
    <script>
        let editToggle = false;

        let popoverTriggerList, popoverList;
        document.addEventListener('DOMContentLoaded', () => {
            popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]')
            popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl))
        })

        async function editFolderName(body) {
            const folderId = location.href.substring(location.href.lastIndexOf('/') + 1);
            const path = `${folderId}/edit`;

            fetch(path, {
                method: 'POST',
                body: JSON.stringify(body)
            })
                .then(response => response.json())
                .then(result => {
                    //    console.log(result);
                    // return result;
                })
        }

        async function toggleEdit() {

            let buttons = document.querySelectorAll('button[name=cardDelete]');
            buttons.forEach(button => button.classList.toggle("hidden"));

            let label = document.querySelector('#label');
            label.classList.toggle('hidden');

            let labelInput = document.querySelector('#labelInput');
            labelInput.classList.toggle('hidden');

            let description = document.querySelector('#description');
            description.classList.toggle('hidden');

            let descriptionInput = document.querySelector('#descriptionInput');
            descriptionInput.classList.toggle('hidden');

            if (editToggle) {
                let body = {};

                if (descriptionInput.value != description.innerHTML) {
                    body['description'] = descriptionInput.value;
                    description.innerHTML = descriptionInput.value;
                }

                if (labelInput.value != label.innerHTML) {
                    body['label'] = labelInput.value;
                    label.innerHTML = labelInput.value;
                }
                if (Object.keys(body).length) {
                    // console.log('changed! Making fetch request')
                    const response = await editFolderName(body);
                    // console.log(response);

                }
            }



            editToggle = !editToggle;
            // console.log('ending of function');
        }
    </script>
    <!-- Button trigger modal -->
    <!-- TODO loadSets() functino is from index  separate in scripts.js-->
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop"
        onclick='loadSets(undefined, "{{request.user}}", "sets", true);'>Add Set</button>
    <button type="button" class="btn btn-secondary" onclick="toggleEdit();">Edit</button>
    <!-- Button trigger modal -->
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteConfirmation">
        Delete
    </button>
    <!-- Modal -->
    <div class="modal fade" id="deleteConfirmation" tabindex="-1" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <form action="{% url 'deleteFolder' folderId %}" method='POST'>
            {% csrf_token %}
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Delete folder</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete this folder?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-danger">Delete Folder</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">Add a Set</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h3>Recent sets</h3>
                    <div id='sets'>

                    </div>
                </div>
                <!-- <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Understood</button>
                </div> -->
            </div>
        </div>
    </div>
    <h3>folder</h3>
    <section id="folderContainer">
        <script>
            function deleteSet(element, evt) {
                evt.preventDefault();
                const path = `${location.href}/addSet`;
                const setId = element.dataset.id;
                const folderId = location.href.substring(location.href.lastIndexOf('/') + 1);
                fetch(path, {
                    method: 'POST',
                    body: JSON.stringify({
                        setId: setId,
                        folderId: folderId
                    })
                })
                    .then(response => response.json())
                    .then(result => {
                        console.log(`#set_${setId}`)
                        document.querySelector(`#set_${setId}`).remove();
                    })
            }
        </script>
        {% for set in folder.sets %}
        <!-- href="{% url 'set' set.id%}" -->
        <a class='set' href="{% url 'set' set.id%}" id="set_{{set.id}}">
            <div class='set-info'>
                <span>
                    <span> {{set.label}}</span>
                    <span style='display: block; margin-top: -.5em;'>{{set.wordsNumber}} terms</span>
                </span>

                {%if set.set_image%}
                <img class='set-icon' src="{{set.set_image.url}}" alt="set icon">
                {%endif%}
                <button type="button" name="cardDelete" class="btn btn-primary hidden" data-id='{{set.id}}'
                    onclick="deleteSet(this, event);"><img src="{% static 'icons/bin.png' %}"
                        alt="delete set from folder"></button>
            </div>
            <div style=''>
                <img src="{% static 'icons/user.png' %}" alt="Author profile icon">
                <span>{{set.author}}</span>
            </div>
        </a>

        <!-- <div class="folder" >
            <section>
                {{set.label}}
            </section>
        </div> -->
        {% endfor %}
    </section>

</section>
{% endblock body %}