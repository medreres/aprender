{% extends 'aprender/study.html' %}
{% block head %}
<style>
    .learn-card {
        background-color: grey;
        border-radius: 30px;
        min-height: 100px;
        min-width: 100px;
        max-width: 800px;
        margin: 0 auto;
        margin-top: 5vh;
        padding: 10px;

        display: flex;
        flex-flow: column nowrap;
    }


    .definition {
        /* margin-bottom: 10vh; */
        align-self: flex-start;
        /* margin: 10px; */
    }

    .definitions {
        margin: 0 auto;
        display: flex;
        flex-flow: row wrap;
        max-width: 700px;

        justify-content: center;
    }

    .answer {
        min-width: 300px;
        margin: 10px;
        transition-duration: 1s;
        transition-property: background-color;
    }

    .answer:focus {
        content: none;
    }

    .hidden {
        display: none;
    }

    .word {
        display: flex;
        justify-content: center;

        justify-content: space-between;
    }

    .roundMenu {
        margin: 10vh auto;
        padding: 10px;
        border: 1px solid black;
    }

    .correct {
        background-color: green !important;
        opacity: 1 !important;
    }

    .incorrect {
        background-color: red !important;
        opacity: 1 !important;
    }

    input[name="written"],
    input[name="multiple"] {
        transition: background-color 1s;
    }
</style>
<script>
    function checkResults(form) {
        const data = new FormData(form);
        console.log(data.getAll('np'))
        return false;
    }
    var numberOfWordsGeneral = {{numberOfWordsGeneral}};
    var numberOfWordsCorrect = 0;
    var currentWord = 0;

    // add id for all questions to parse them easier and hides all words
    function addIndexes() {
        document.querySelectorAll('.learn-card').forEach((element, index) => {
            if (index != 0)
                element.classList.add('hidden');
            element.id = `id_${index}`;
        })
    }

    document.addEventListener('DOMContentLoaded', () => {
        addIndexes();
    })

    function checkAnswer(element) {
        const url = new URL(location.href);
        let path = url.origin + '/sets/{{id}}/learn/check';
        // console.log(element.value)
        // console.log(path);
        fetch(path, {
            method: 'POST',
            body: JSON.stringify({
                'id': element.dataset.id,
                'definition': element.value
            })
        })
            .then(response => response.json())
            .then(result => {
                if (result['answer'] === true) {
                    element.classList.toggle('correct');
                    // console.log('correct');
                    numberOfWordsCorrect++;
                } else {
                    // console.log('incorrect');
                    element.classList.toggle('incorrect');
                }


                setTimeout(() => {
                    toggleNextDiv(currentWord);
                    toggleNextDiv(currentWord + 1);
                    currentWord++;
                }, 2000)
            })
    }

    function toggleNextDiv(id) {
        document.querySelector(`#id_${id}`).classList.toggle('hidden');
    }


    function checkWord(evt) {
        if (evt.name === 'written') {
            disable(evt);
            // console.log(`input[name="written"] [data-id="${evt.dataset.id}"]`)
            let definition = document.querySelector(`input[name="written"][data-id="${evt.dataset.id}"]`);
            // console.log(definition);
            checkAnswer(definition);
        } else if (evt.name === 'multiple') {
            document.querySelectorAll(`input[name="multiple"][data-id="${evt.dataset.id}"]`).forEach(element => element
                .classList.toggle('disabled'))
            checkAnswer(evt);
        } else if (evt.name === 'true') {
            // console.log(evt.value);
            document.querySelectorAll(`button[name="true"][data-id="${evt.dataset.id}"]`).forEach(element => element
                .classList.toggle('disabled'))
            checkAnswer(evt);
        }
    }

    function disable(element) {
        element.disabled = true;
    }
</script>

{% endblock head %}

{% comment %} TODO show one after another all the divs, check their answer , at the end show end menu with
score{% endcomment %}
{% block body %}
<section>
    {% csrf_token %}
    {% comment %} each word has it's keys: word, definition, id {% endcomment %}
    {% for key,value in questions.items %}
    {% for word in value %}
    <div class='learn-card'>
        <span>Definition</span>
        <div class='word-container'>
            <span class='word'>{{word.word}}</span>
            {% if key == 'true' %}
            means {{word.definitionRandom}}
            {% endif %}
            <div class='picture'></div>
        </div>


        <div class='definitions'>
            <!-- for each type of question different method is used -->
            {% if key == 'multiple' %}
            {% for definition in word.definition %}
            <input type="button" class="btn btn-primary answer" data-id='{{word.id}}' value='{{definition}}'
                name="multiple" onclick="checkWord(this);" />
            {% endfor %}
            {% elif key == 'written' %}
            <!-- just check spelling via checkWord() function -->
            <input type="text" data-id='{{word.id}}' name='written' autocomplete="off">
            <button onclick="checkWord(this);" data-id="{{word.id}}" name="written"
                class="btn btn-primary">Check</button>
            {% elif key == 'true' %}
            <!-- TODO implement mechanism for checking via true/false -->
            {% comment %} {{word.definition}} {% endcomment %}
            {% if word.definitionRandom == word.definitionTrue %}
            <button type="button" name="true" class="btn btn-primary answer" data-id='{{word.id}}'
                value="{{word.definitionTrue}}" onclick="checkWord(this);">True</button>
            <button type="button" name="true" class="btn btn-primary answer" data-id='{{word.id}}' value=""
                onclick="checkWord(this);">False</button>
            {% else %}
            <button type="button" name="true" class="btn btn-primary answer" data-id='{{word.id}}'
                value="{{word.definitionRandom}}" onclick="checkWord(this);">True</button>
            <button type="button" name="true" class="btn btn-primary answer" data-id='{{word.id}}'
                value="{{word.definitionTrue}}" onclick="checkWord(this);">False</button>
            {% endif %}
            {% endif %}
        </div>
    </div>
    {% endfor %}
    {% endfor %}
    <button type="submit" class='btn btn-primary hidden'>Submit</button>
</section>

<section id='result' class="hidden">

    <h2>Result</h2>


</section>
{% endblock %}