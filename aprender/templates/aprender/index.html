{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    {% load bootstrap5 %}

    {% bootstrap_css %}

    {% bootstrap_javascript %}
    <style>
        .card {
            margin: 5px 0;
        }

        .card:hover {
            cursor: pointer;
            box-shadow: 0 0 5px #fd7e14;
        }
    </style>

    <link rel="stylesheet" href="{% static 'styles/index.css' %}">
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            // initially load colelction of sets
            loadSets(undefined);

            // on click for eact tab load content correspondingly (sets/folders)
            let setsButton = document.querySelector("#setsButton");
            setsButton.addEventListener('click', (evt) => {
                evt.stopPropagation();
                loadSets(evt);

                toggleActive('setsButton', 'foldersButton');
                toggleHidden('foldersLink', 'setsLink');
            });

            let foldersButton = document.querySelector("#foldersButton");
            foldersButton.addEventListener('click', (evt) => {
                evt.stopPropagation();
                loadFolders(evt);

                toggleActive('setsButton', 'foldersButton');
                toggleHidden('foldersLink', 'setsLink');
            });
            // document.querySelector('#libraryBtn').addEventListener('click', loadSets);
        })

        function loadSets(event, username = '{{request.user}}', id = 'containerAjax') {
            fetch(`${username}/fetchSetsAjax`)
                .then(response => response.json())
                .then(result => {
                    if (result.length === 0) {
                        addCard(undefined, id);
                    } else {
                        result.forEach(card => addCard(card, id));
                    }
                })
        }

        function addCard(card, id = 'containerAjax') {

            if (card === undefined) {
                document.querySelector(`#${id}`).innerHTML =
                    "It's seem that there is nothing to show!";
                return;
            }
            document.querySelector(`#${id}`).innerHTML = "";
            const numberOfEntities = ('wordsNumber' in card) ? `${card['wordsNumber']} words` :
                `${card['setsNumber']} sets`
            let template = document.createElement('div');
            template.classList.add('card');
            template.innerHTML = `<div class="card-header">
                ${card['label']}
            </div>
            <div class="card-body">
                ${numberOfEntities}
            </div>`;
            template.onclick = () => {
                // provide location of the set/folder to reroute on click
                // define if it's a set or a folder
                if ('setsNumber' in card)
                {
                    location.href = `${card['author']}/folders/${card['id']}`;
                }
                else
                {
                    location.href = `${card['author']}/sets/${card['id']}`;
                }
            }

            setTimeout(() => {
                document.querySelector(`#${id}`).append(template);
            }, 1)
        }

        function loadFolders(event, username = '{{request.user}}', id = 'containerAjax') {
            fetch(`${username}/fetchFoldersAjax`)
                .then(response => response.json())
                .then(result => {
                    if (result.length === 0) {
                        addCard(undefined);
                        return;
                    } else {
                        result.forEach(card => addCard(card, id))
                    }
                })
        }


        function toggleActive(...ids) {
            // console.log(a1,a2);
            // toggle classes for css
            ids.forEach(id => { document.querySelector(`#${id}`).classList.toggle('active'); })
        }

        function toggleHidden(...ids) {
            ids.forEach(id => { document.querySelector(`#${id}`).classList.toggle('hidden'); })
        }

    </script>
    {% block scripts %}{% endblock scripts %}

    <title>live</title>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'index' %}">Navbar</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo02"
                aria-controls="navbarTogglerDemo02" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarTogglerDemo02">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="{% url 'index' %}">Home</a>
                    </li>
                    {% if user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a id="libraryBtn" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            Your Library
                        </a>
                        <ul class="dropdown-menu p-2">
                            <ul class="nav nav-tabs">
                                <li class="nav-item">
                                    <a id='setsButton' class="nav-link active text-dark" aria-current="page">Sets</a>
                                </li>
                                <li class="nav-item">
                                    <a id='foldersButton' class="nav-link text-dark" aria-current="page">Folders</a>
                                </li>
                            </ul>
                            <div id="containerAjax">
                                <!-- Here goes folders and sets -->

                            </div>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <a href="{% url 'sets' request.user %}" id="setsLink">View all sets</a>
                            <a href="{% url 'folders' request.user %}" id="foldersLink" class="hidden">View all
                                folders</a>
                        </ul>
                    </li>

                    <li class="nav-item dropdown">
                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            Create
                        </button>
                        <ul class="dropdown-menu">
                            <li><a href="{% url 'createset' %}" class="dropdown-item" type="button">Study Set</a></li>
                            <li>
                                <button type="button" class="dropdown-item" data-bs-toggle="modal"
                                    data-bs-target="#folderModal">
                                    Folder
                                </button>
                            </li>
                        </ul>

                        {% comment %} Form for creating folder {% endcomment %}
                        <div class="modal fade" id="folderModal" tabindex="-1" aria-labelledby="folderModalLabel"
                            aria-hidden="true">
                            <div class="modal-dialog">
                                <form action="{% url 'createfolder' %}" method="post">
                                    {% csrf_token %}
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="folderModalLabel">Create a new folder</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            {{CreateFolder.label}}
                                            {{CreateFolder.description}}
                                        </div>
                                        <div class="modal-footer">
                                            <input type="submit" class="btn btn-primary" value='Create a folder' />
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                    </li>
                    {% endif %}
                </ul>
                <form class="d-flex" role="search">
                    <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
                </form>
                {% if not request.user.is_authenticated %}
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        Sign In
                    </button>
                    <div class="dropdown-menu dropdown-menu-lg-end">
                        <form class="px-4 py-3" method='post' action="{% url 'login' %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="DropdownFormEmail1" class="form-label">Email address</label>
                                {{LoginForm.username}}
                            </div>
                            <div class="mb-3">
                                <label for="DropdownFormPassword1" class="form-label">Password</label>
                                {{LoginForm.password}}
                            </div>
                            <button type="submit" class="btn btn-primary">Sign in</button>
                        </form>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="{% url 'register' %}">New around here? Sign up</a>
                        <a class="dropdown-item" href="#">Forgot password?</a>
                    </div>
                </div>
                {% else %}
                <div class="btn-group">
                    <a type="button" class="m-2" data-bs-toggle="dropdown" data-bs-display="static"
                        aria-expanded="false">
                        <img src="{% static 'icons/user.png' %}" alt="profile pic">
                    </a>
                    <ul class="dropdown-menu dropdown-menu-lg-end">
                        <li>
                            <div id='container'>
                                {% comment %} TODO USERS PIC {% endcomment %}
                                <img class="profilePicSm" src="{% static 'icons/image.jpeg' %}" alt="profile pic">
                                <div id='body'>
                                    <p id='username'> <strong>{{request.user}}</strong></p>
                                    <p id='email'>{{request.user.email}}</p>
                                </div>
                            </div>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="{% url 'profile' request.user %}" type="button">Profile</a>
                        </li>
                        <li><button class="dropdown-item" type="button">Another action</button></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="{% url 'logout' %}">Log Out</a></li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </nav>
    {% bootstrap_messages %}

    {% block body %}
    {% endblock body %}
</body>

</html>